# MDL 服务器管理系统 — 功能分享文档

**日期**：2026-02-28
**作者**：运维研发团队
**适用版本**：release-src v2.x

---

## 一、整体运维流程

系统覆盖 MDL 服务器从上线到日常运维的完整生命周期，共分三条路径：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  路径 1：新服务器上线（首次）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  申请服务器
      │
      ▼
  【发布系统 → 服务器管理】
  录入服务器信息（FQDN、IP、目录、Consul 配置等）
  可选：同时创建配置实例并提交 Git
      │
      ▼
  【发布系统 → 服务器管理 → 初始化】
  一键执行 Ansible 自动化初始化：
    · 安装系统工具包
    · 创建运维用户和目录结构
    · 配置 coredump、DNS、systemd service
    · 出口机器：上传配置文件、安装 Anaconda、配置 cron
      │
      ▼
  服务器环境就绪，等待首次版本部署
      │
      ▼
  【进入路径 2：版本上线】


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  路径 2：日常版本上线 / 配置变更（标准流程）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  开发完成，准备发布
      │
      ▼
  【Jira】
  创建发布工单（包含版本号、发布说明）
      │
      ▼
  【发布系统 → 发布计划】
  创建发布计划，关联 Jira 工单，选择发布对象（服务器）
  发布类型：
    · 版本发布：更新服务二进制版本（需关联 Jira）
    · 配置变更：仅更新配置文件（可不关联 Jira）
      │
      ▼
  【发布系统 → 发布计划 → 发布入口】
  按序逐台发布，支持：
    · 暂停 / 继续
    · 失败重试 / 跳过
    · 发布成功 7 天内可回滚
      │
      ▼
  发布完成


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  路径 3：紧急故障 — 仅需改配置（快速通道）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  线上故障，排查确认是配置问题
      │
      ▼
  【发布系统 → 配置管理】
  直接在浏览器修改配置（无需 SSH，无需走 Jira 流程）
  支持：单台编辑 / 批量修改 / 文本查找替换
      │
      ▼
  一键部署（Consul 推送 + Ansible 远程重载服务）
      │
      ▼
  故障恢复。如果改错了 → 历史版本回滚 → 重新部署

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

> **路径 2 是日常标准流程**，有完整的审批和记录。
> **路径 3 是紧急通道**，跳过 Jira 走变更审批，仅限配置级别的修复，操作全程有审计日志记录。

---

## 二、背景与运维痛点

### 过去的运维方式

在引入本系统之前，MDL 服务器的管理和初始化完全依赖手工操作：

1. **服务器信息分散**
   服务器的 IP、FQDN、安装目录、Consul 配置等信息分散记录在 Wiki 或 Excel 表格中，查找困难，容易过期失效。

2. **初始化流程复杂、易遗漏**
   新服务器上线前需要手工执行十余个步骤：安装软件包、创建运维用户、配置 sudoers、调整系统 limits、配置 coredump 路径、配置 DNS、部署 systemd service、设置 cron 任务……每次都要对照 `init.sh` 脚本逐步执行，耗时约 20–40 分钟，且容易遗漏步骤。

3. **出口机器配置更繁琐**
   出口机器还需额外手动上传 `get_cloud_conf.py`、`users_tcp.cfg`、`users_tcp.cfg.local` 三个配置文件，并安装 Anaconda 环境，配置 cron 定时任务，步骤更多。

4. **批量操作无法实现**
   新环境批量上线时（如扩容 10 台），只能一台一台 SSH 进去重复操作，效率极低。

5. **配置实例与 Git 需要手动同步**
   新增服务器后还需要手动在配置管理系统中创建对应节点，并将空配置文件提交到 GitLab，容易被忘记导致配置系统状态不一致。

---

## 二、现在能解决什么问题

| 痛点 | 解决方案 | 效果 |
|------|---------|------|
| 服务器信息分散 | 统一录入数据库，Web 界面管理 | 集中查询，支持搜索和标签分类 |
| 初始化流程复杂 | 一键 Ansible 自动化执行全部步骤 | 点击按钮，等待完成，无需 SSH |
| 出口机器配置繁琐 | 界面上传文件，自动部署 + cron | 上传文件即可，全程自动 |
| 批量上线效率低 | 批量新增 + 批量初始化 | 填一张表，所有服务器并发录入、串行初始化 |
| 配置实例需手动同步 | 新增服务器时可选"同时创建配置实例并提交 Git" | 一次操作，服务器 + 配置实例 + Git 同步完成 |
| 初始化过程无法监控 | 实时日志面板，2 秒轮询更新 | 全程可见，失败原因一目了然 |
| 故障时修改配置需 SSH 登录手工操作 | 配置管理页面在线编辑、批量修改 | 无需 SSH，浏览器直接改配置并一键部署 |
| 配置变更无历史记录、无法回滚 | 每次保存自动快照，支持版本回滚 | 出问题随时回滚到上一个版本 |
| 多台服务器配置差异难以排查 | 一致性巡检功能 | 一眼看出哪台机器配置和其他机器不同 |

---

## 三、功能详解

### 3.1 发布计划（日常版本上线 / 配置变更）

**入口**：左侧菜单 → MDL 管理 → 发布计划

发布计划是日常版本上线和配置变更的标准通道，**所有正常发布必须经过此流程**，有完整的 Jira 关联、发布记录和回滚能力。

#### 发布类型

| 类型 | 说明 | 是否需要 Jira |
|------|------|--------------|
| 版本发布 | 更新服务二进制版本 | 必须关联 |
| 配置变更 | 仅更新配置文件 | 可不关联 |

#### 创建发布计划

| 字段 | 必填 | 说明 |
|------|------|------|
| 发布名称 | ✓ | 唯一，便于搜索和区分 |
| 计划发布时间 | ✓ | 预定窗口时间 |
| 类型 | ✓ | 版本发布 / 配置变更 |
| Jira 单号 | 版本发布时必填 | 从 Jira 获取可选工单列表 |
| 发布对象 | ✓ | 选择目标服务器，支持按标签批量选择 |

选择发布对象后会生成**发布顺序列表**，支持拖拽调整顺序。版本发布时，每台服务器的版本号会从 Jira 工单自动填充。

#### 发布执行流程

创建完成后，点击列表行的"**发布入口**"进入执行页面：

```
按顺序逐台发布
    │
    ├─ 当前台发布中 → 等待结果
    │       ├─ 成功 → 自动进入下一台
    │       └─ 失败 → 选择：失败重试 或 跳过
    │
    ├─ 随时可"暂停" → 稍后点"继续"
    │
    └─ 全部完成 → 状态：发布成功
```

#### 状态说明

| 状态 | 含义 |
|------|------|
| 未发布 | 已创建，尚未点击发布入口 |
| 发布中 | 正在逐台执行 |
| 暂停 | 中途暂停，等待继续 |
| 发布成功 | 全部完成 |
| 发布失败 | 有台失败且未跳过 |
| 回滚中 / 回滚成功 / 回滚失败 | 回滚操作状态 |

#### 回滚

发布成功后 **7 天内**可以回滚，点击"回滚"按钮恢复到发布前的版本。超过 7 天后所有操作按钮自动禁用。

#### 权限说明

- **创建/编辑/删除**：发布计划的创建人
- **执行发布**：devops 或 admin 角色
- **查看列表**：所有人

---

### 3.2 服务器列表页

**入口**：左侧菜单 → MDL 管理 → 服务器管理

页面提供以下能力：

#### 搜索与筛选
- **关键词搜索**：输入框支持按 FQDN、IP 地址、服务名模糊搜索（400ms 防抖）
- **标签筛选**：下拉框按标签过滤服务器

#### 工具栏
| 按钮 | 说明 |
|------|------|
| 新增服务器 | 打开单个服务器新增表单 |
| 批量新增 | 打开表格式批量新增弹窗 |
| 批量初始化（N） | 对已勾选的 N 台服务器批量初始化（未选中时禁用） |
| 标签管理 | 增删服务器分类标签 |
| 刷新 | 重新加载列表 |

#### 表格列
| 列名 | 可排序 | 说明 |
|------|--------|------|
| FQDN | ✓ | 服务器完整域名 |
| IP 地址 | ✓ | |
| 服务名 | ✓ | 如 `mdl-forward` |
| 标签 | — | 该服务器关联的分类标签 |
| 安装目录 | ✓ | 服务二进制文件路径 |
| 备份目录 | ✓ | |
| Python 路径 | ✓ | |
| 操作 | — | 编辑 / 初始化 / 删除 |

> 点击列表头箭头可按该列升序或降序排列，再次点击恢复原序。

---

### 3.3 新增 / 编辑服务器

点击工具栏"新增服务器"或表格行"编辑"按钮打开弹窗。

#### 基础字段

| 字段 | 必填 | 默认值 | 说明 |
|------|------|--------|------|
| FQDN | ✓ | — | 如 `mdl-fwd-prod01` |
| IP 地址 | ✓ | — | 如 `10.121.21.240` |
| 服务名 | ✓ | `mdl-forward` | systemd service 名称 |
| 角色名 | — | `forward` | Ansible 角色标识 |
| SSH 用户 | ✓ | `root` | 初始化时使用的 SSH 用户 |
| 远端 Python | — | `/opt/anaconda/bin/python` | Ansible 远端解释器路径 |
| 安装目录 | ✓ | `/datayes/forward/bin` | 服务部署路径 |
| 备份目录 | ✓ | `/datayes/forward/backup` | 备份存放路径 |
| Consul KV 前缀 | — | — | Consul 配置路径 |
| Consul Token | — | — | Consul 认证 Token（密码输入框） |
| 配置文件 | — | `feeder_handler.cfg` | 逗号分隔的配置文件名 |
| Git 配置链接 | — | — | GitLab 中该服务配置文件的链接 |
| 标签 | — | — | 支持多选，用于分类过滤 |

#### 新增时特有功能

**① 复制已有服务器**

在"复制已有服务器"下拉框中选择一台现有服务器，系统会自动把其角色名、用户、Python 路径、目录等配置填入表单，只需修改 FQDN 和 IP 即可快速新增同类服务器。

**② 同时创建配置实例并提交 Git**

勾选此选项后，保存时系统会自动：
1. 在配置管理中创建对应的 ServiceType 和 ConfigInstance
2. 为每个配置文件名创建空白占位文件
3. 将空配置文件提交到 GitLab（自动生成 commit message，也可自定义）

保存完成后弹窗内会展示详细结果（配置实例创建状态、Git 提交状态），即使部分步骤失败也会明确说明，服务器记录不会丢失。

---

### 3.4 单个服务器初始化

点击表格行"初始化"按钮，打开初始化弹窗，分两个阶段：

#### 阶段一：确认参数

弹窗顶部展示目标服务器的基本信息（只读），然后填写：

| 字段 | 说明 |
|------|------|
| SSH 用户名 | 可选，留空使用服务器配置的用户名 |
| SSH 密码 | 可选，留空使用系统全局配置的密码 |
| 是出口机器 | 勾选后显示文件上传区域 |

**出口机器文件上传**（仅勾选"是出口机器"时显示）：

- **出口配置文件**：需上传 3 个文件
  - `get_cloud_conf.py`
  - `users_tcp.cfg`
  - `users_tcp.cfg.local`
  - 上传后自动复制到该服务器的安装目录
- **Anaconda 包**：上传 `.tar` / `.tar.gz` 文件，自动解压到 `/opt` 目录

#### 阶段二：执行与日志

点击"开始初始化环境"后：
- 弹窗切换到日志视图，显示运行状态（运行中 / 成功 / 失败）
- 黑底白字日志面板每 2 秒刷新一次，自动滚动到最新内容
- 完成后给出明确提示，成功则引导通过 Jira 发布流程部署版本

#### Ansible 自动化执行的步骤

初始化过程完全自动化，执行以下所有步骤：

| 步骤 | 操作 |
|------|------|
| 1 | 安装工具包：`lrzsz`、`iftop`、`gdb`、`jq`、`dsniff` |
| 2 | 创建运维用户 `zhixiong.zeng`（密码 `datayes@123`） |
| 3 | 配置 sudoers 免密提权 |
| 4 | 设置 limits.conf（core dump 无限制） |
| 5 | 创建安装目录、备份目录、日志目录 |
| 6 | 创建 coredump 目录 `/datayes/corefiles` |
| 7 | 配置 `/etc/sysctl.conf`，coredump 写入 `/datayes/corefiles/` |
| 8 | 配置 DNS（`/etc/systemd/resolved.conf`），写入内网 DNS 地址 |
| 9 | 部署 systemd service 文件并设置开机自启 |
| 10（出口机器）| 上传 3 个出口配置文件到安装目录 |
| 11（出口机器）| 配置 cron 任务（每 10 分钟执行 `get_cloud_conf.py`） |
| 12（出口机器）| 上传并解压 Anaconda 包到 `/opt` |

---

### 3.5 批量新增服务器

点击工具栏"批量新增"按钮。

弹窗以**表格形式**展示，每行代表一台服务器：

- 点击"添加一行"逐行增加
- 每行可独立填写 FQDN、IP、服务名、角色名、SSH 用户、安装目录、备份目录、标签
- FQDN 和 IP 为必填项，其余字段有默认值
- 点击"批量保存"后逐台提交，每行显示成功/失败状态
- 弹窗底部汇总：`完成：X 台成功，Y 台失败`
- 单台失败不影响其他台继续创建

**适用场景**：新环境批量扩容，或从 Excel 复制数据批量录入。

---

### 3.6 批量初始化服务器

在服务器列表中勾选多行，工具栏的"批量初始化（N）"按钮变为可用。

弹窗分两阶段：

#### 阶段一：参数确认
- 统一设置 SSH 用户名和密码（留空使用各服务器配置的默认值）
- 展示即将初始化的服务器列表（FQDN、IP、服务名、安装目录）

#### 阶段二：串行执行

| 功能 | 说明 |
|------|------|
| 进度表格 | 每台服务器独立显示状态：等待中 → 执行中 → 成功/失败 |
| 实时日志 | 显示当前正在执行的服务器的实时输出 |
| 日志归档 | 每台完成后可点击"查看日志"回看完整日志 |
| 汇总统计 | 全部完成后显示"X 台成功，Y 台失败" |

> 批量初始化为**串行执行**：每台完成后再执行下一台，避免并发 SSH 连接对网络造成冲击。

---

### 3.7 标签管理

点击工具栏"标签管理"按钮，可以：
- **新建标签**：输入名称后点击"添加"
- **删除标签**：点击标签行右侧删除按钮

标签创建后可在以下地方使用：
- 新增/编辑服务器表单中关联标签
- 服务器列表页按标签筛选

---

### 3.8 配置管理

**入口**：左侧菜单 → MDL 管理 → 配置管理

配置管理是专门应对**线上故障需要紧急修改配置并重新部署**的核心功能。整个操作全程在浏览器完成，无需 SSH 登录服务器。

#### 核心概念：三层树结构

```
ServiceType（服务类型）     如：forward、gateway
  └─ ConfigInstance（实例） 如：forward_10_24_71_73（对应一台服务器）
       └─ ConfigFile（文件）如：feeder_handler.cfg
```

#### 页面布局

页面分左右两栏：
- **左侧**：配置树（支持按实例名搜索，可勾选多个节点）
- **右侧**：Monaco 代码编辑器（JSON 格式，支持语法高亮、格式化）

#### 顶部操作栏

| 按钮 | 权限 | 功能 |
|------|------|------|
| 同步 | 操作员+ | 从 GitLab 拉取最新配置到数据库 |
| 批量修改 | 操作员+ | 同时修改多个实例的配置（需先勾选） |
| 提交 Git | 操作员+ | 将本地修改提交到 GitLab |
| 推送 Consul | 操作员+ | 将配置推送到 Consul KV（服务运行时读取的配置源） |
| 部署 | 管理员 | Consul 推送 + Ansible 远程重载配置，完整的一键部署 |
| 操作日志 | 所有人 | 查看谁在什么时间做了什么操作 |
| 一致性巡检 | 所有人 | 检查同类型服务各实例之间的配置差异 |

---

### 3.9 配置编辑与保存

点击左侧树中的配置文件节点，右侧编辑器加载该文件的 JSON 内容。

**编辑器特性**：
- JSON 语法高亮和实时错误提示
- `Ctrl+S` / `Cmd+S` 快捷键保存
- 粘贴内容时自动格式化
- 有未保存修改时切换文件会弹出确认对话框，防止误操作丢失数据

**保存流程**：
```
编辑内容 → 验证 JSON 格式 → 保存到数据库
                                 ↓
                    自动创建历史快照（可回滚）
                                 ↓
                         写入审计日志
```

---

### 3.10 批量修改

**使用场景**：需要同时修改多台服务器上同一个配置项（如把所有 forward 实例的某个 IP 地址统一从 `10.1.1.1` 改为 `10.1.1.2`）。

在左侧树中勾选多个实例，点击"批量修改"按钮，弹窗内提供两种修改模式：

#### 模式一：结构化修改

以树形界面展示 JSON 配置的层级结构，同时显示各实例当前的值：

```
├─ server
│  ├─ host    [警告：各实例值不同]  inst1: 10.1.1.1  inst2: 10.1.1.2
│  └─ port    [统一值: 8080]
└─ database
   └─ url     [统一值: jdbc:mysql://...]
```

勾选要修改的配置项后，在右侧输入框填写新值，支持：
- **修改现有值**：填入新值，应用到所有选中实例
- **删除配置项**：点击删除按钮，将该 key 从所有实例中移除
- **新增配置项**：输入 key 路径（支持嵌套，如 `server.newKey`）和值，添加到所有实例

点击"应用修改"后，系统批量更新所有选中实例并记录审计日志。

#### 模式二：文本查找替换

适合需要全局替换某个字符串的场景（如批量替换 IP 地址、域名等）：

1. 输入**查找文本**和**替换文本**
2. 点击"预览"，系统展示每个实例受影响的行和修改前后的对比
3. 确认无误后点击"应用替换"

预览展示示例：
```
实例                   匹配数   差异预览
forward_10_24_71_73      3    第10行: - "host": "10.1.1.1"
                              第10行: + "host": "10.2.2.2"
forward_10_24_71_74      0    无匹配
```

> 替换后系统会自动验证 JSON 格式，若替换导致格式非法则拒绝保存并给出错误提示。

---

### 3.11 配置部署（紧急故障处置）

**适用场景**：配置改好之后，需要把新配置推送到服务器并让服务生效。

在左侧树中勾选需要部署的**实例节点**，点击"部署"按钮（需管理员权限）：

#### 阶段一：预览确认

弹窗展示将要部署的实例列表，每个实例显示：
- 实例名称、服务类型、IP 地址
- 部署目录、服务名
- Consul KV 路径
- 将要推送的配置文件列表

#### 阶段二：执行部署

点击"确认部署"后，系统**并发**为每个实例执行两步操作：

```
Step 1：推送 Consul
  将配置文件内容 PUT 到 Consul KV
  （服务读取配置的数据源）

Step 2：Ansible 远程部署
  连接目标服务器 → 从 Consul 拉取最新配置 → 重载服务
```

**实时日志**示例：
```
[11:30:00] === 部署 forward/forward_10_24_71_73 ===
  [STEP 1] 推送 Consul...
    OK: configs/mdl/forward/forward_10_24_71_73/feeder_handler.cfg
  [STEP 2] Ansible → 10.24.71.73...
    Ansible OK
[11:30:08] === 部署 forward/forward_10_24_71_74 ===
  [STEP 1] 推送 Consul...
    ...
```

- 日志面板每 2 秒刷新一次，自动滚动到底部
- 全部完成后显示"全部部署成功"或"部分实例失败"

---

### 3.12 版本历史与回滚

每次保存配置时，系统自动将修改前的版本存档。在编辑器区域可打开"历史"抽屉，查看该文件的所有历史版本：

- 查看每个历史版本的完整内容
- 与当前版本对比差异
- 点击"回滚"将该历史版本恢复为当前配置

**典型场景**：部署后发现新配置有问题，立刻点"回滚"恢复到上一个版本，再重新部署。

---

### 3.13 一致性巡检

**使用场景**：怀疑某台服务器的配置和其他同类服务器不一致，需要排查。

点击"一致性巡检"，系统对比同一 ServiceType 下所有实例的配置差异，输出：
- 有差异的配置项路径（如 `server.host`、`database.url`）
- 哪些实例在这些 key 上的值与众不同

---

### 3.14 GitLab 同步与提交

配置管理与 GitLab 双向同步：

**GitLab → 数据库（同步）**：点击"同步"按钮，系统从 GitLab 下载最新的配置文件压缩包，按目录结构（`ServiceType/Instance/filename`）解析并更新数据库，自动创建不存在的 ServiceType、Instance、ConfigFile。

**数据库 → GitLab（提交）**：勾选配置文件后点击"提交 Git"，填写 commit message，系统将配置内容提交到 GitLab 仓库作为版本备份。

---

### 3.15 操作审计日志

所有涉及配置变更的操作均会被记录，可通过"操作日志"按钮查看：

| 记录内容 | 说明 |
|---------|------|
| 操作类型 | 保存、批量修改、文本替换、Git 提交、Consul 推送、部署 |
| 操作人 | 当前登录用户 |
| 操作时间 | 精确到秒 |
| 影响实例 | 本次操作涉及的实例列表 |
| 操作概述 | 人类可读的操作描述 |
| 执行结果 | 成功 / 失败 / 部分成功 |

支持按操作类型、操作人、日期范围过滤查询。

---

## 四、使用方法（标准流程）

### 场景一：新服务器上线（首次初始化）

```
1. 进入"服务器管理"页面，点击"新增服务器"
2. 如果同类服务器已存在：在"复制已有服务器"选择参考服务器 → 修改 FQDN 和 IP
3. 如需同步配置管理：勾选"同时创建配置实例并提交 Git"，填写服务类型和实例名称
4. 点击"保存"，查看结果提示
5. 回到列表，找到新服务器，点击"初始化"
6. 确认 SSH 信息（如无特殊情况留空即可）
7. 点击"开始初始化环境"，等待完成
   → Ansible 自动执行：安装工具包、创建用户、配置目录、systemd 服务、DNS 等
8. 初始化成功后，前往发布计划走首次版本上线流程
```

### 场景二：批量上线多台服务器（如扩容）

```
1. 进入"服务器管理"页面，点击"批量新增"
2. 在表格中逐行填写每台服务器信息
3. 点击"批量保存"，等待完成，确认所有行均为"成功"
4. 回到列表，勾选新增的全部服务器
5. 点击"批量初始化（N）"，填写统一的 SSH 密码（留空使用全局配置）
6. 点击"开始批量初始化"，等待所有服务器依次完成
7. 全部成功后，通过发布计划批量上线版本
```

### 场景三：出口机器上线

```
1. 按"场景一"步骤新增服务器
2. 点击"初始化"打开弹窗
3. 勾选"是出口机器"
4. 上传 3 个出口配置文件（get_cloud_conf.py、users_tcp.cfg、users_tcp.cfg.local）
5. 上传 anaconda.tar 安装包
6. 点击"开始初始化环境"
   → 自动将配置文件复制到安装目录
   → 自动解压 Anaconda 到 /opt
   → 自动配置 cron 任务（每 10 分钟拉取云配置）
```

### 场景四：日常版本上线（标准流程）

```
1. 开发完成后，在 Jira 创建发布工单（含版本号）
2. 进入"发布计划"页面，点击"创建发布计划"
3. 填写发布名称、计划时间
4. 选择类型：版本发布
5. 选择 Jira 工单（版本号自动填充）
6. 选择发布对象（服务器），支持按标签批量选择，可拖拽调整顺序
7. 保存发布计划
8. 到达发布窗口时，点击"发布入口"开始执行
   → 按序逐台发布，每台完成后自动进入下一台
   → 如某台失败：选择"重试"或"跳过"继续
   → 全部完成 → 状态变为"发布成功"
9. 发布成功后 7 天内如需回滚，点击"回滚"按钮
```

### 场景五：仅配置变更上线（标准流程）

```
1. 进入"发布计划"页面，点击"创建发布计划"
2. 选择类型：配置变更（不需要关联 Jira）
3. 选择发布对象
4. 保存后按发布流程执行
```

> 配置变更如果不紧急，走此标准流程有完整记录；如果是线上故障紧急处置，走场景六。

### 场景六：故障时紧急修改配置并重新部署

```
1. 进入"配置管理"页面
2. 在左侧树找到出故障的服务实例，点击配置文件
3. 在右侧编辑器中修改配置内容（如调整连接参数、切换备用地址等）
4. Ctrl+S 保存（自动创建历史快照）
5. 勾选该实例，点击"部署"
6. 弹窗中确认部署信息，点击"确认部署"
7. 查看实时日志，等待部署完成
   → 自动推送 Consul → Ansible 远程重载服务
8. 如果部署后问题更严重：点击"历史" → 选择上一版本 → "回滚" → 重新部署
```

### 场景七：批量修改多台服务器的同一配置项

```
1. 进入"配置管理"页面
2. 在左侧树中勾选所有需要修改的实例（如整个 forward 下的全部实例）
3. 点击"批量修改"
4. 选择模式：
   - 若修改某个具体字段 → 结构化修改：在树中找到该字段，输入新值
   - 若需要替换某个字符串（如 IP 地址变更）→ 文本替换：填写查找和替换内容
5. 预览确认变更内容无误
6. 点击"应用修改"/"应用替换"
7. 勾选所有实例，点击"部署"，一键全部部署
```

### 场景八：排查配置不一致问题

```
1. 进入"配置管理"页面
2. 点击"一致性巡检"
3. 查看差异报告，找出哪台机器的哪个配置项和其他机器不同
4. 点击该实例的配置文件，手动修正或通过批量修改统一配置
5. 部署修正后的配置
```

---

## 五、技术说明

### 架构

```
前端（Vue 2 + Element UI）
  ├── 服务器管理
  │     ├── serverManagement.vue         主页面
  │     ├── ServerFormModal.vue          新增/编辑弹窗
  │     ├── InitServerModal.vue          单台初始化弹窗
  │     ├── BatchAddModal.vue            批量新增弹窗
  │     └── BatchInitModal.vue           批量初始化弹窗
  └── 配置管理
        ├── configManagement.vue         主页面（左树右编辑器）
        ├── ConfigEditor.vue             Monaco JSON 编辑器
        ├── DeployModal.vue              部署弹窗（预览+实时日志）
        └── BatchEditModal.vue           批量修改弹窗（结构化+文本替换）

后端（Django REST Framework）
  ├── mdl_server_viewset.py（服务器管理）
  │     ├── GET/POST /api/mdl-servers/          列表/新增
  │     ├── GET/PUT/DEL /api/mdl-servers/{id}/  详情/编辑/删除
  │     ├── POST /api/mdl-servers/{id}/init/    启动初始化
  │     ├── GET  /api/mdl-servers/{id}/init_status/  轮询状态
  │     ├── GET/POST /api/mdl-labels/           标签列表/新建
  │     └── DEL  /api/mdl-labels/{id}/          删除标签
  └── config_mgmt_viewset.py（配置管理）
        ├── GET  /api/config-mgmt/tree/                    配置树
        ├── GET/PUT /api/config-mgmt/configs/{id}/         查看/保存配置
        ├── POST /api/config-mgmt/configs/batch_update/    批量修改
        ├── POST /api/config-mgmt/configs/text_replace/    文本替换
        ├── POST /api/config-mgmt/configs/git_commit/      提交 GitLab
        ├── POST /api/config-mgmt/configs/push_consul/     推送 Consul
        ├── GET  /api/config-mgmt/configs/consistency_check/ 一致性巡检
        ├── POST /api/config-mgmt/sync/                    从 GitLab 同步
        ├── POST /api/config-mgmt/deploy/                  创建部署任务
        ├── GET  /api/config-mgmt/deploy/{id}/             轮询部署状态
        ├── GET  /api/config-mgmt/history/                 历史版本列表
        ├── POST /api/config-mgmt/history/{id}/rollback/   回滚版本
        └── GET  /api/config-mgmt/audit-logs/              审计日志

自动化（Ansible）
  └── ansi/mdl/
        ├── deploy_feeder_init.yml    服务器初始化 playbook
        ├── deploy_config.yml         配置部署 playbook（Consul→服务器）
        └── roles/feeder/tasks/
              └── init.yml            初始化步骤定义

外部集成
  ├── GitLab         配置文件版本控制（拉取 archive / 提交 commits）
  ├── Consul KV      运行时配置分发（服务启动时从这里读配置）
  └── Ansible        远程执行（部署配置到目标服务器并重载服务）
```

### 初始化任务执行机制

1. 前端点击"开始初始化"→ 调用 `POST /api/mdl-servers/{id}/init/`
2. 后端在数据库创建 `ConfigDeployTask` 记录（status=running），立即返回 `task_id`
3. 后台线程异步执行 `ansible-playbook`（不阻塞 API）
4. Ansible 为每次初始化创建独立临时目录（`/tmp/mdl_init_*/`），hosts 文件和 host_vars 均动态生成，避免并发冲突
5. 执行完成后将完整日志写入数据库，更新状态为 success/failed
6. 前端每 2 秒轮询 `init_status` 接口，拉取最新 log 和 status 展示

### 关键设计决策

| 决策 | 原因 |
|------|------|
| 初始化用独立临时目录而非固定 hosts 文件 | 支持多台服务器并发初始化（互不干扰） |
| 批量初始化串行而非并行 | 避免同时发起大量 SSH 连接压垮网络 |
| 编辑时调用详情接口而非直接用列表数据 | 列表接口可能因分页/性能原因省略字段（如 config_git_url） |
| 标签 M2M 从 Label 端操作 | 符合 Django ORM 的 M2M 关系约定 |

---

## 六、常见问题

**Q：初始化失败，日志显示空**
A：通常是 SSH 连接失败（密码错误/端口不通）或 Ansible 执行环境问题。初始化日志加了 `-v` 详细模式，失败时会在日志面板展示完整的 Ansible 错误信息，包括 `[stderr]` 部分。

**Q：安装目录不对，创建在了错误的路径**
A：之前的版本有一个遗留静态 `host_vars/release.yml` 文件覆盖了动态配置，已修复（删除该静态文件）。现在安装目录完全由数据库中服务器的 `install_dir` 字段决定。

**Q：新增服务器时"同时创建配置实例"失败了，服务器还在吗**
A：在。服务器记录会先保存到数据库，配置实例和 Git 提交作为附加步骤。如果附加步骤失败，弹窗会以 warning 提示并说明失败原因，服务器记录不受影响，可以手动在配置管理页面创建对应节点。

**Q：批量新增中某几台失败了怎么办**
A：失败的行会显示红色"失败"标签。弹窗不会关闭，可以修正对应行的信息后再次点击"批量保存"（已成功的行会再次提交，但服务器名唯一时后端会返回冲突错误，可忽略或先删除重复记录）。

**Q：配置管理里"同步"和"提交 Git"有什么区别**
A：方向相反。"同步"是把 GitLab 上的最新内容拉到数据库（GitLab → 数据库）；"提交 Git"是把数据库里修改过的内容推送到 GitLab（数据库 → GitLab）。正常工作流程：在系统里修改 → 提交 Git 备份 → 推送 Consul → 部署到服务器。

**Q：部署和"推送 Consul"有什么区别**
A："推送 Consul"只把配置写到 Consul KV，服务不会自动感知并重载。"部署"是完整流程：推送 Consul + Ansible 远程连接服务器执行重载动作，配置才真正生效。紧急故障处置时用"部署"，不要只推 Consul。

**Q：批量修改时，文本替换模式会不会破坏 JSON 格式**
A：不会。替换完成后系统会自动尝试 `JSON.parse` 验证格式，如果替换导致 JSON 非法，该实例会被标记为错误并跳过，不会保存损坏的内容。

**Q：历史版本能保留多久、保留多少条**
A：每次保存（含批量修改、文本替换、回滚）都会生成一条历史记录，理论上无上限。数据存在数据库中，如有清理需求可联系管理员按时间批量删除旧记录。

**Q：一致性巡检发现差异，但某台机器就是应该配置不同怎么办**
A：巡检只是展示差异，不会强制要求一致，忽略即可。如果确认差异合理，无需任何操作。

---

*文档生成时间：2026-02-28*
