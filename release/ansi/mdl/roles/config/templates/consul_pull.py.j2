#!/usr/bin/env python3
import os
import requests
import base64
from urllib.parse import urlparse

CONSUL_SPACE = '{{ consul_space }}'
CONSUL_TOKEN = os.environ['CONSUL_TOKEN']

parsed_url = urlparse(CONSUL_SPACE)
base_url = '{uri.scheme}://{uri.netloc}/'.format(uri=parsed_url)
CONSUL_UI_URL = CONSUL_SPACE

FILE_DIR = '{{ install_dir }}'
FILE_STR = '{{ consul_files | default(None) }}'
if FILE_STR:
    FILES = FILE_STR.split(',')
else:
    FILES = ['feeder_handler.cfg']


def fetch_and_save_file(consul_url, filename):
    headers = {'X-Consul-Token': CONSUL_TOKEN}
    response = requests.get(consul_url, headers=headers)
    if response.status_code == 200:
        value = base64.b64decode(response.json()[0]['Value'])
        file_path = os.path.join(FILE_DIR, filename)
        with open(file_path, 'wb') as f:
            f.write(value)
    else:
        print('Failed to get %s' % filename)
        exit(1)


def get_conf():
    for filename in FILES:
        consul_url = '{}{}'.format(CONSUL_SPACE, filename)
        fetch_and_save_file(consul_url, filename)


if __name__ == '__main__':
    get_conf()